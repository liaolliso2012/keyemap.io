<html>    
    <head>
        <meta charset="UTF-8">
        <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="http://maps.googleapis.com/maps/api/js?v=3&sensor=false&key=AIzaSyCgrYHfhsghwjRf_AjL_GBHUMVEc6z-auk&language=zh-CN&libraries=places,geometry"></script>
        <link rel="stylesheet" type="text/css" href="css/jquery-autocomplete.css" />
        <link rel="stylesheet" type="text/css" href="css/gmap3-menu.css" />
        <link type="text/css" rel="stylesheet" href="css/jquery.dropdown.css" />

        <script type="text/javascript" src="js/jquery-autocomplete.js"></script>
        <script type="text/javascript" src="js/gmap3.min.js"></script>
        <script type="text/javascript" src="js/gmap3-menu.js"></script>
        <script type="text/javascript" src="js/jquery.dropdown.min.js"></script>

        <style>
            #container{
                position:relative;
                height:700px;
            }
            #directions{
                position:absolute;
                width: 23%;
                right:1%;
                height: 690px;
                overflow:auto;
            }
            #googleMap{
                border: 1px dashed #C0C0C0;
                width: 75%;
                height: 700px;
            }

        </style>

        <script type="text/javascript">
            $(function() {

                var $map = $("#googleMap"),
                        menu = new Gmap3Menu($map),
                        routePoints = [],
                        routePointsWI = [];

                function drawRoute(twoPoints) {
                    console.log('draw route');
                    console.log(twoPoints.length);
                    if (twoPoints.length > 1) {
                        var start = new google.maps.LatLng(twoPoints[0].lat(), twoPoints[0].lng());
                        var end = new google.maps.LatLng(twoPoints[1].lat(), twoPoints[1].lng());
                        $map.gmap3({
                            getroute: {
                                options: {
                                    origin: start,
                                    destination: end,
                                    travelMode: google.maps.DirectionsTravelMode.DRIVING
                                },
                                callback: function(results) {
                                    console.log(results);
                                    if (!results)
                                        return;
                                    $(this).gmap3({
                                        map: {
                                            options: {
                                                center: [39.915, 116.404],
                                                zoom: 7
                                            }
                                        },
                                        directionsrenderer: {
                                            options: {
                                                draggable: true,
                                                directions: results,
                                                markerOptions: {
                                                    draggable: true,
                                                    icon: 'http://maps.google.com/mapfiles/marker_green.png'
                                                }
                                            },
                                            events: {
                                                directions_changed: function(directionsrenderer, event, context) {
                                                    console.log('route chaned');
                                                    // HERE send ajax request to backend to save the waypoints
                                                    //console.log(directionsrenderer);
                                                    var points = directionsrenderer.directions.routes[0].legs[0];
                                                    console.log(points);
                                                    for (var i = 0; i < points.via_waypoints.length; i++) {
                                                        var wp = points.via_waypoints[i];
                                                        console.log(wp.lat());
                                                        console.log(wp.lng());
                                                        var tmplocation = new google.maps.LatLng(wp.lat(), wp.lng());
                                                        updateRouteWithWaypoint(wp);
                                                        // add actions to this waypoint
                                                        $map.gmap3({
                                                            //clear: "marker",
                                                            marker: {
                                                                latLng: tmplocation,
                                                                options: {
                                                                    draggable: true,
                                                                    icon: 'http://maps.google.com/mapfiles/marker_green.png'
                                                                },
                                                                events: {
                                                                    mouseover: function(marker, event, context) {
                                                                        console.log('im over');
                                                                    },
                                                                    click: function(marker, event, context) {
                                                                        console.log('im clicked');
                                                                        $map.gmap3({
                                                                            infowindow: {
                                                                                //address:tmplocation,
                                                                                options: {
                                                                                    position: tmplocation,
                                                                                    content: "You can do anything here: <input type='text' name='note' id='note' /><input type='button' id='addnote' name='addnote' value='添加备注'/>"
                                                                                },
                                                                                events: {
                                                                                    closeclick: function(infowindow) {
                                                                                        alert("closing : " + infowindow.getContent());
                                                                                    },
                                                                                    domready: function(infowindow) {
                                                                                        $('#addnote').click(function() {
                                                                                            alert('add note success');
                                                                                            infowindow.close();
                                                                                        });
                                                                                    }
                                                                                }
                                                                            }
                                                                        });
                                                                    },
                                                                    dragend: function(marker) {
                                                                        console.log('im dragged');
                                                                        console.log(marker.position.lat());
                                                                        console.log(marker.position.lng());
                                                                    }
                                                                }
                                                            }
                                                        });
                                                    }

                                                }
                                            }
                                        }
                                    });
                                }
                            }
                        });
                    }
                }

                // MENU : ITEM 1
                menu.add("Direction to here", "itemB",
                        function() {
                            menu.close();
                            addMarker(false);
                        });

                // MENU : ITEM 2
                menu.add("Direction from here", "itemA separator",
                        function() {
                            menu.close();
                            addMarker(true);
                        })

                // MENU : ITEM 3
                menu.add("Zoom in", "zoomIn",
                        function() {
                            var map = $map.gmap3("get");
                            map.setZoom(map.getZoom() + 1);
                            menu.close();
                        });

                // MENU : ITEM 4
                menu.add("Zoom out", "zoomOut",
                        function() {
                            var map = $map.gmap3("get");
                            map.setZoom(map.getZoom() - 1);
                            menu.close();
                        });

                // MENU : ITEM 5
                menu.add("Center here", "centerHere",
                        function() {
                            $map.gmap3("get").setCenter(current.latLng);
                            menu.close();
                        });

                // INITIALIZE GOOGLE MAP
                $map.gmap3({
                    map: {
                        options: {
                            center: [39.915, 116.404],
                            zoom: 7,
                            mapTypeControl: true,
                            mapTypeControlOptions: {
                                style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
                            },
                            navigationControl: true,
                            scrollwheel: true,
                            streetViewControl: true
                        },
                        events: {
                            rightclick: function(map, event) {
                                current = event;
                                menu.open(current);
                            },
                            click: function() {
                                menu.close();
                            },
                            dragstart: function() {
                                menu.close();
                            },
                            zoom_changed: function() {
                                menu.close();
                            }
                        }
                    }
                });

                var c = 0;
                $("#addWaypoint").click(function() {
                    if ($(this).prev().attr('id') == 'start') {
                        var input = '<input type="text" name="onway0" id="onway0" placeholder="途经点" class="address"/>';
                        $(input).insertBefore($(this));
                        autoCompleteIt('onway0');
                    } else {
                        if ($('#waypointList').children().length == 0) {
                            $('#waypointList').html('<ul class="dropdown-menu"></ul>');
                        }
                        var input = '<input type="text" name="onway' + c + '" id="onway' + c + '" placeholder="途经点' + c + '" class="address"/>';
                        $(input).appendTo($('.dropdown-menu'));
                        autoCompleteIt('onway' + c);
                    }
                    c++;
                    $('#waypointList').dropdown('show');
                });

                $("#searchMap").click(function() {
                    // clear the route first
                    removePath();
                    generateRoute();
                });

                // id: the sequence of input, eid
                function autoCompleteIt(eid) {
                    var elm = $('#' + eid);
                    var cid = eid;
                    if (cid != 'start' && cid != 'end') {
                        cid = cid.substr(5);
                    }
                    //console.log(cid);
                    if (typeof elm.attr('id') != 'undefined') {
                        elm.autocomplete({
                            source: function() {
                                $map.gmap3({
                                    getaddress: {
                                        address: {
                                            address: $(this).val(),
                                            region: 'zh-cn'
                                        },
                                        callback: function(results) {
                                            //console.log(results);
                                            if (!results) {
                                                alert('无法识别该地点，请使用其它地点！');
                                                return false;
                                            }
                                            elm.autocomplete("display", results, false);
                                            return;
                                        }
                                    }
                                });
                            },
                            cb: {
                                cast: function(item) {
                                    return item.formatted_address;
                                },
                                select: function(item) {
                                    //console.log(item.geometry.location.lat());
                                    //console.log(item.geometry.location.lng());
                                    var tmpPoint = {};
                                    tmpPoint.id = cid;
                                    tmpPoint.lat = item.geometry.location.lat();
                                    tmpPoint.lng = item.geometry.location.lng();
                                    tmpPoint.title = item.formatted_address;
                                    tmpPoint.html = item.formatted_address;
//                                    console.log(cid);
//                                    console.log(tmpPoint);
                                    updateRoute(cid, tmpPoint);
                                },
                                unselect: function() {
                                    // TODO: we convert the value into point and save it to routePoints
                                    
                                }
                            },
                            delay: 500
                        }).focus();
                    }
                }

                function removePath() {
                    $map.gmap3({
                        clear: {
                            name: ["directionsrenderer"]
                        }
                    });
                }
                function updateRoute(cid, thePoint) {
                    //console.log(cid);
                    var tmp = new google.maps.LatLng(thePoint.lat, thePoint.lng);
                    routePointsWI[cid] = tmp;
                    // update routePoints based on routePointsWI
                    console.log('compare');
                    console.log(routePointsWI);
                    for(i in routePointsWI) {
                        if(i == 'start')
                            routePoints[0] = routePointsWI['start'];
                        else if(i == 'end')
                            routePoints[Object.size(routePointsWI)-1] = routePointsWI['end'];
                        else
                            routePoints[parseInt(i)+1] = routePointsWI[parseInt(i)];
                    }
                    console.log(routePoints);
                }

                function generateRoute() {
                    var c = routePoints.length;
                    if (c < 2) {
                        if ($('#start').val() != '' && $('#end').val() != '') {
                            //TODO when routePoints < 2, we use form input to render the route

                        } else
                            return false;
                    }

                    routePoints.sort(function(a, b) {
                        return parseInt(a) > parseInt(b) ? 1 : -1
                    });
                    for (i in routePoints) {
                        i = parseInt(i);
                        if (i < c - 1)
                            drawRoute([routePoints[i], routePoints[i + 1]]);
                    }
                }

                var rad = function(x) {
                    return x * Math.PI / 180;
                };

                var getDistance = function(p1, p2) {
                    var R = 6378137; // Earth’s mean radius in meter
                    var dLat = rad(p2.lat() - p1.lat());
                    var dLong = rad(p2.lng() - p1.lng());
                    var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                            Math.cos(rad(p1.lat())) * Math.cos(rad(p2.lat())) *
                            Math.sin(dLong / 2) * Math.sin(dLong / 2);
                    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    var d = R * c;
                    return d; // returns the distance in meter
                };

                // when dragging the route, we need to update routePoints
                function getNewIndex(point) {
                    var dif = [];
                    for (i in routePoints) {
                        var tmp = {};
                        tmp.seq = i;
                        tmp.diff = getDistance(point, routePoints[i]);
                        dif.push(tmp);
                    }
                    dif.sort(compare);
                    //console.log(dif);
                    return Math.max(dif[0].seq, dif[1].seq);
                }
                
                function updateRouteWithWaypoint(point) {
                    var idx = getNewIndex(point);
                    console.log(routePoints);
                    routePoints.splice(idx, 0, point);
                    console.log(routePoints);
                }

                Object.size = function(obj) {
                    var size = 0, key;
                    for (key in obj) {
                        if (obj.hasOwnProperty(key))
                            size++;
                    }
                    return size;
                };

                function compare(a, b) {
                    if (a.diff < b.diff)
                        return -1;
                    if (a.diff > b.diff)
                        return 1;
                    return 0;
                }

                autoCompleteIt('start');
                autoCompleteIt('end');
            });
        </script>  
    </head>

    <body>
        <div id="container">
            <input type="text" id="start" name="start" placeholder="起点"  class="address"/>
            <input type="button" name="addWaypoint" id="addWaypoint" value="+" data-dropdown="#waypointList" data-horizontal-offset="-250"/>
            <input type="text" id="end" name="end" placeholder="终点"  class="address"/>
            <input type="button" id="searchMap" name="searchMap" value="生成路线"/>
            <div id="directions">

            </div>
            <div id="googleMap"></div>
            <div id="waypointList" class="dropdown dropdown-tip">

            </div>
        </div>
    </body>
</html>
