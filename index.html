<html>    
    <head>
        <meta charset="UTF-8">
        <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="http://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&key=AIzaSyCgrYHfhsghwjRf_AjL_GBHUMVEc6z-auk&language=zh-CN&libraries=places,geometry"></script>
        <link rel="stylesheet" type="text/css" href="css/jquery-autocomplete.css" />
        <link rel="stylesheet" type="text/css" href="css/gmap3-menu.css" />

        <script type="text/javascript" src="js/jquery-autocomplete.js"></script>
        <script type="text/javascript" src="js/gmap3.min.js"></script>
        <script type="text/javascript" src="js/gmap3-menu.js"></script>
        <style>
            #container{
                position:relative;
                height:700px;
            }
            #directions{
                position:absolute;
                width: 23%;
                right:1%;
                height: 690px;
                overflow:auto;
            }
            #googleMap{
                border: 1px dashed #C0C0C0;
                width: 75%;
                height: 700px;
            }
        </style>

        <script type="text/javascript">
            $(function() {

                var $map = $("#googleMap"),
                        menu = new Gmap3Menu($map),
                        current, // current click event (used to save as start / end position)
                        twoPoints = [], // use to store current and previous point for drawing route
                        m1, // marker "from"
                        m2;       // marker "to"

                $("#address").autocomplete({
                    source: function() {
                        $("#googleMap").gmap3({
                            getaddress: {
                                address: $(this).val(),
                                callback: function(results) {
                                    //console.log(results);
                                    if (!results)
                                        return;
                                    $("#address").autocomplete("display", results, false);
                                }
                            }
                        });
                    },
                    cb: {
                        cast: function(item) {
                            return item.formatted_address;
                        },
                        select: function(item) {
                            console.log(item.geometry.location.lat());
                            console.log(item.geometry.location.lng());
                            var tmpPoint = {};
                            tmpPoint.lat = item.geometry.location.lat();
                            tmpPoint.lng = item.geometry.location.lng();
                            tmpPoint.title = item.formatted_address;
                            tmpPoint.html = item.formatted_address;
                            updateTwoPoints(tmpPoint);
                            drawRoute();
                            // add marker
                            $("#googleMap").gmap3({
                                //clear: "marker",
                                marker: {
                                    latLng: item.geometry.location,
                                    options: {
                                        draggable: true,
                                        icon: 'http://maps.google.com/mapfiles/marker_green.png'
                                    }
                                },
                                map: {
                                    options: {
                                        center: item.geometry.location,
                                        zoom: 7
                                    }
                                }
                            });
                            $("#address").val('下一站').select();
                            
                        }
                    }
                }).focus();


                function drawRoute() {
                    console.log('draw route');
                    if (twoPoints.length > 1) {
                        var start = new google.maps.LatLng(twoPoints[0].lat, twoPoints[0].lng);
                        var end = new google.maps.LatLng(twoPoints[1].lat, twoPoints[1].lng);
                        $("#googleMap").gmap3({
                            getroute: {
                                options: {
                                    origin: start,
                                    destination: end,
                                    travelMode: google.maps.DirectionsTravelMode.DRIVING
                                },
                                callback: function(results) {
                                    if (!results)
                                        return;
                                    $(this).gmap3({
                                        map: {
                                            options: {
                                                center: [39.915, 116.404],
                                                zoom: 7
                                            }
                                        },
                                        directionsrenderer: {
                                            options: {
                                                draggable: true,
                                                
                                                directions: results,
                                                markerOptions: {
                                                    draggable: true,
                                                    icon: 'http://maps.google.com/mapfiles/marker_green.png'
                                                }
                                            },
                                            events:{
                                                directions_changed: function(directionsrenderer, event, context){
                                                    console.log('route chaned');
                                                    // HERE send ajax request to backend to save the waypoints
                                                    var points = directionsrenderer.directions.routes[0].legs[0];
                                                    console.log(points);
                                                    for(var i=0; i<points.via_waypoints.length;i++) {
                                                        var wp = points.via_waypoints[i];
                                                        console.log(wp.lat());
                                                        console.log(wp.lng());
                                                        var tmplocation = new google.maps.LatLng(wp.lat(), wp.lng());
                                                        // add actions to this waypoint
                                                        $("#googleMap").gmap3({
                                                            //clear: "marker",
                                                            marker: {
                                                                latLng: tmplocation,
                                                                options: {
                                                                    draggable: true,
                                                                    icon: 'http://maps.google.com/mapfiles/marker_green.png'
                                                                },
                                                                events: {
                                                                    mouseover: function(marker, event, context) {
                                                                        console.log('im over');
                                                                    },
                                                                    click: function(marker, event, context) {
                                                                        console.log('im clicked');
                                                                        $("#googleMap").gmap3({
                                                                            infowindow:{
                                                                               //address:tmplocation,
                                                                               options:{
                                                                                   position:tmplocation,
                                                                                   content: "You can do anything here: <input type='text' name='note' id='note' /><input type='button' id='addnote' name='addnote' value='添加备注'/>"
                                                                               },
                                                                               events:{
                                                                                   closeclick: function(infowindow){
                                                                                       alert("closing : " + infowindow.getContent());
                                                                                   },
                                                                                   domready: function(infowindow){
                                                                                       $('#addnote').click(function(){
                                                                                            alert('add note success');
                                                                                            infowindow.close();
                                                                                       });
                                                                                   }
                                                                               }
                                                                            }
                                                                        });
                                                                    },
                                                                    dragend: function(marker) {
                                                                        console.log('im dragged');
                                                                        console.log(marker.position.lat());
                                                                        console.log(marker.position.lng());
                                                                    }
                                                                }
                                                            }
                                                        });
                                                    }
                                                    
                                                }
                                            }
                                        }
                                    });
                                }
                            }
                        });
                    }
                }
                

                function updateTwoPoints(item) {
                    if (twoPoints.length < 2) {
                        twoPoints.push(item);
                    } else {
                        twoPoints = [twoPoints[1]];
                        twoPoints.push(item);
                    }
                    console.log(twoPoints);
                }
                

                // MENU : ITEM 1
                menu.add("Direction to here", "itemB",
                        function() {
                            menu.close();
                            addMarker(false);
                        });

                // MENU : ITEM 2
                menu.add("Direction from here", "itemA separator",
                        function() {
                            menu.close();
                            addMarker(true);
                        })

                // MENU : ITEM 3
                menu.add("Zoom in", "zoomIn",
                        function() {
                            var map = $map.gmap3("get");
                            map.setZoom(map.getZoom() + 1);
                            menu.close();
                        });

                // MENU : ITEM 4
                menu.add("Zoom out", "zoomOut",
                        function() {
                            var map = $map.gmap3("get");
                            map.setZoom(map.getZoom() - 1);
                            menu.close();
                        });

                // MENU : ITEM 5
                menu.add("Center here", "centerHere",
                        function() {
                            $map.gmap3("get").setCenter(current.latLng);
                            menu.close();
                        });

                // INITIALIZE GOOGLE MAP
                $map.gmap3({
                    map: {
                        options: {
                            center: [39.915, 116.404],
                            zoom: 7,
                            mapTypeControl: true,
                            mapTypeControlOptions: {
                                style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
                            },
                            navigationControl: true,
                            scrollwheel: true,
                            streetViewControl: true
                        },
                        events: {
                            rightclick: function(map, event) {
                                current = event;
                                menu.open(current);
                            },
                            click: function() {
                                menu.close();
                            },
                            dragstart: function() {
                                menu.close();
                            },
                            zoom_changed: function() {
                                menu.close();
                            }
                        }
                    }
                });
                

            });
        </script>  
    </head>

    <body>
        <div id="container">
            <input type="text" id="address" name="address" placeholder="起点"/>
            <div id="directions">

            </div>
            <div id="googleMap"></div>
        </div>
    </body>
</html>
