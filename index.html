<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>拖拽导航</title>
        <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
        <script language="javascript" src="http://webapi.amap.com/maps?v=1.2&key=d8d5649a8338723fe59b001624404b3f"></script>
        <link rel="stylesheet" type="text/css" href="http://api.amap.com/Public/css/demo.Default.css" />
        <script language="javascript">
            var mapObj, route, marker, geocoder;
            var points = []; // used to store routes
            var c = 0; // use to store how many time +/- clicked
            
            $(document).ready(function() {

                var position = new AMap.LngLat(116.404, 39.915);//创建中心点坐标  
                mapObj = new AMap.Map("iCenter", {center: position});//创建地图实例

                $('.btngrp').on('click', '#add_point', function() {
                    console.log('add point');
                    c++;
                    var tmp = $('#onway0').clone(true, false);
                    tmp.attr('id', 'onway' + c);
                    tmp.attr('name', 'onway' + c);
                    tmp.attr('value', '');
                    tmp.attr('placeholder', '途经点');
                    tmp.insertAfter($('#onway' + (c - 1)));
                });

                $('.btngrp').on('click', '#generateRoute', function() {
                    console.log(points);
                    var path = [];
                    for(i=0;i<points.length;i++) {
                        path.push(new AMap.LngLat(points[i].lng, points[i].lat));
                    }
                    mapObj.plugin("AMap.DragRoute", function() {
                        route = new AMap.DragRoute(mapObj, path, AMap.DrivingPolicy.LEAST_FEE); //构造拖拽导航类
                        route.search(); //查询导航路径并开启拖拽导航
                    });
                });
                
                $('.point').blur(function(){
                    if($(this).val() == '')
                        return false;
                    console.log('blur to get lat/lng');
                    var eid = $(this).attr('id');
                    var pointid = 0;
                    if(eid === 'start' || eid === 'end') {
                        pointid = eid;
                    } else 
                        pointid = eid.substr(5);
                    $('#curpos_id').val(pointid);
                    var pointname = $(this).val();
                    getCord(pointname);
                    
                });

                
                //console.log(points);
            });

            function getCord(place) {
                //加载地理编码插件
                mapObj.plugin(["AMap.Geocoder"], function() {
                    geocoder = new AMap.Geocoder({
                        radius: 1000, //以已知坐标为中心点，radius为半径，返回范围内兴趣点和道路信息
                    });
                    //返回地理编码结果
                    AMap.event.addListener(geocoder, "complete", geocoder_callback);
                    geocoder.getLocation(place);
                });
            }

            function geocoder_callback(data) {
                var resultStr = "";
                //地理编码结果数组  
                var geocode = new Array();
                geocode = data.geocodes;
//                console.log(geocode);
//                console.log(geocode.length);
                if(geocode.length > 0) {
//                    console.log('Push ' + geocode[0].formattedAddress + ' into points');
//                    console.log(geocode[0]);
                    var pointid = $('#curpos_id').val();

                    geocode[0].location.id = pointid;
                    geocode[0].location.address = geocode[0].formattedAddress;
                    
                    var result = $.grep(points, function(e){ return e.id == pointid; });
                    if (result.length == 0) {
                        points.push(geocode[0].location);
                    } else if (result.length == 1) {
                        // update the point
                        $.each(points, function() {
                            if (this.id == pointid) {
                                this.lat = geocode[0].location.lat;
                                this.lng = geocode[0].location.lng;
                                this.j = geocode[0].location.lat;
                                this.l = geocode[0].location.lng;
                                this.address = geocode[0].formattedAddress;
                            }
                        });
                    }
                }
                mapObj.setFitView();
                //console.log(points);
                //document.getElementById("result").innerHTML = resultStr;
            }
        </script>
    </head>
    <body>
        <div class="btngrp">
            <input type="button" class="add_point" id="add_point" name="add_point" value="添加途经点" />
            <input type="button" name="generateRoute" id="generateRoute" value="生成路线" />
        </div>
        <div class="points">
            <input type="text" name="start" id="start" value="" class="point" placeholder="起点"/>
            <div class="onwaypoints">
                <input type="text" name="onway0" id="onway0" value="" class="point onway" placeholder="途经点"/>
            </div>
            <input type="text" name="end" id="end" value="" class="point" placeholder="终点"/>
        </div>
        <div style="width:820px;height:500px;border:1px solid gray" id="iCenter"></div>
        <div id="result"></div>
        <input type="hidden" id="curpos_id" value="" />
        <input type="hidden" id="curpos_name" value="" />
    </body>
</html>
